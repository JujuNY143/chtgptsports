import fetch from 'node-fetch';
import Parser from 'rss-parser';

const parser = new Parser();

export default async function handler(req, res) {
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader("Access-Control-Allow-Methods", "GET, OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");

  if (req.method === "OPTIONS") {
    res.status(204).end();
    return;
  }

  const sportsMap = {
    MLB: ['baseball', 'mlb'],
    NBA: ['basketball', 'nba'],
    NFL: ['football', 'nfl'],
    MLS: ['soccer', 'usa.1'],
    NCAAF: ['football', 'college-football'],
    NCAAB: ['basketball', 'mens-college-basketball'],
  };

  const today = new Date();
  const games = [];
  const news = [];

  try {
    for (const [sport, [group, league]] of Object.entries(sportsMap)) {
      const url = `https://site.api.espn.com/apis/site/v2/sports/${group}/${league}/scoreboard`;
      const resp = await fetch(url);
      const data = await resp.json();

      if (!data.events) continue;

      for (const event of data.events) {
        const comp = event.competitions[0];
        const home = comp.competitors.find(t => t.homeAway === 'home');
        const away = comp.competitors.find(t => t.homeAway === 'away');
        const status = comp.status.type;

        const isToday = new Date(event.date).toDateString() === today.toDateString();
        const isLive = status.state === 'in';

        if (isToday || isLive) {
          games.push({
            type: isLive || status.completed ? 'score' : 'upcoming',
            sport,
            emoji: getSportEmoji(sport),
            team1: away?.team?.abbreviation || 'TBD',
            team2: home?.team?.abbreviation || 'TBD',
            score1: parseInt(away?.score ?? 0),
            score2: parseInt(home?.score ?? 0),
            status: formatGameStatus(comp, sport),
          });
        }
      }
    }
  } catch (err) {
    console.error('ESPN fetch failed', err);
  }

  try {
    const feeds = [
      'https://www.espn.com/espn/rss/news',
      'https://www.bleacherreport.com/articles/feed',
      'https://news.google.com/rss/search?q=sports&hl=en-US&gl=US&ceid=US:en'
    ];

    for (const feed of feeds) {
      const parsed = await parser.parseURL(feed);
      parsed.items.slice(0, 3).forEach(item => {
        news.push({
          type: 'news',
          content: item.title,
          breaking: false
        });
      });
    }
  } catch (err) {
    console.error('RSS fetch failed', err);
  }

  if (games.length === 0) {
    news.unshift({
      type: 'news',
      content: 'Live scores unavailable â€” Showing sports headlines instead.',
      breaking: true
    });
  }

  res.status(200).json({ games, news });
}

function getSportEmoji(sport) {
  return {
    MLB: 'âš¾',
    NBA: 'ğŸ€',
    NFL: 'ğŸˆ',
    MLS: 'âš½',
    NCAAF: 'ğŸˆ',
    NCAAB: 'ğŸ€',
  }[sport] || 'ğŸ†';
}

function formatGameStatus(comp, sport) {
  const { type, displayClock, completed } = comp.status;

  if (completed) return 'FINAL';
  if (type.state === 'in') {
    if (sport === 'MLS') return `${displayClock || ''}`;
    return displayClock || type.shortDetail || 'LIVE';
  }

  const d = new Date(comp.date);
  return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) + ' ET';
}

